{% extends "base.html" %}
{% block content %}
<section class="space-y-6">
  <div>
    <p class="text-sm text-gray-600">Завантажте CSV/XLSX з колонками <code>name</code>, <code>code</code>, <code>attributes_raw</code>. Попередні дані буде очищено.</p>
  </div>

  <form id="upload-form" class="space-y-4" enctype="multipart/form-data">
    <div class="rounded-xl border border-dashed border-slate-200 bg-white px-6 py-6 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Завантажити таблицю</h2>
          <p class="text-sm text-gray-600">Підтримується .csv або .xlsx</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <input id="file-input" name="file" type="file" accept=".csv,.xlsx" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white file:text-sm hover:file:bg-indigo-700 focus:outline-none" required />
          <button type="submit" class="inline-flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Завантажити</button>
        </div>
      </div>
      <div class="hidden mt-4" id="upload-success">
        <div class="rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800">Файл успішно завантажений. Дані оновлено.</div>
      </div>
      <div class="hidden mt-4" id="upload-error">
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800"></div>
      </div>
    </div>
  </form>

  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900">Завантажені товари</h3>
      <span id="product-count" class="text-sm text-gray-500">{{ products|length }} товар(и)</span>
    </div>
    <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Назва</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Код</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Кількість характеристик</th>
          </tr>
        </thead>
        <tbody id="product-table" class="divide-y divide-slate-200 text-sm">
          {% for product in products[:150] %}
          <tr>
            <td class="px-4 py-3 text-gray-900">{{ product.name }}</td>
            <td class="px-4 py-3 text-gray-700">{{ product.code }}</td>
            <td class="px-4 py-3 text-gray-700">{{ product.attributes_parsed | length }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">Дані відсутні</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  const uploadForm = document.getElementById('upload-form');
  const fileInput = document.getElementById('file-input');
  const tableBody = document.getElementById('product-table');
  const productCount = document.getElementById('product-count');
  const uploadSuccess = document.getElementById('upload-success');
  const uploadError = document.getElementById('upload-error');

  const toggleAlert = (el, message = '', show = false) => {
    el.classList.toggle('hidden', !show);
    if (message) {
      el.querySelector('div').textContent = message;
    }
  };

  const renderProducts = (products) => {
    tableBody.innerHTML = '';
    if (!products.length) {
      tableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">Дані відсутні</td></tr>';
      productCount.textContent = '0 товарів';
      return;
    }

    products.slice(0, 150).forEach((product) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-4 py-3 text-gray-900">${product.name || ''}</td>
        <td class="px-4 py-3 text-gray-700">${product.code || ''}</td>
        <td class="px-4 py-3 text-gray-700">${Object.keys(product.attributes_parsed || {}).length}</td>
      `;
      tableBody.appendChild(row);
    });
    productCount.textContent = `${products.length} товар(и)`;
  };

  uploadForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    toggleAlert(uploadSuccess, '', false);
    toggleAlert(uploadError, '', false);

    const file = fileInput.files[0];
    if (!file) {
      toggleAlert(uploadError, 'Оберіть файл для завантаження.', true);
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.detail || 'Помилка завантаження');
      }

      const data = await response.json();
      renderProducts(data.products || []);
      toggleAlert(uploadSuccess, 'Файл успішно завантажений. Дані оновлено.', true);
    } catch (error) {
      toggleAlert(uploadError, error.message, true);
    }
  });
</script>
{% endblock %}
