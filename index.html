<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Парсер товарів</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-gray-900 min-h-screen">
  <div class="max-w-6xl mx-auto py-10 px-4 sm:px-6 lg:px-8 space-y-8">
    <header class="space-y-2">
      <p class="text-sm text-gray-500">FastAPI · Jinja2 · Tailwind</p>
      <h1 class="text-3xl font-bold text-gray-900">Парсер товарів</h1>
    </header>

    <div class="rounded-xl bg-white shadow-sm border border-slate-200">
      <nav class="flex flex-wrap gap-2 border-b border-slate-200 px-4 sm:px-6 py-3" aria-label="Tabs">
        <button data-tab="dashboard" class="tab-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Dashboard</button>
        <button data-tab="analysis" class="tab-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Аналіз товару</button>
        <button data-tab="parser" class="tab-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Тест парсера</button>
        <button data-tab="upload" class="tab-btn px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Завантаження товарів</button>
      </nav>

      <section id="tab-dashboard" class="tab-panel px-4 sm:px-6 py-6 space-y-4">
        <h2 class="text-xl font-semibold text-gray-900">Dashboard</h2>
        <p class="text-gray-700 text-sm">Тут буде швидкий огляд ключових метрик та короткий звіт по останніх завантаженнях.</p>
      </section>

      <section id="tab-analysis" class="tab-panel px-4 sm:px-6 py-6 space-y-4 hidden">
        <h2 class="text-xl font-semibold text-gray-900">Аналіз товару</h2>
        <p class="text-gray-700 text-sm">Додайте сюди віджети аналітики, графіки та статистику по товарах.</p>
      </section>

      <section id="tab-parser" class="tab-panel px-4 sm:px-6 py-6 space-y-4 hidden">
        <h2 class="text-xl font-semibold text-gray-900">Тест парсера</h2>
        <p class="text-gray-700 text-sm">Зона для тестових запусків парсера та перегляду результатів.</p>
      </section>

      <section id="tab-upload" class="tab-panel px-4 sm:px-6 py-8 space-y-8 hidden">
        <div class="space-y-2">
          <h2 class="text-2xl font-bold text-gray-900">Завантаження товарів з таблиці</h2>
          <p class="text-sm text-gray-600 leading-relaxed">Підтримуються формати CSV та XLSX.<br />Таблиця повинна містити колонки: <code>name</code>, <code>code</code>, <code>attributes_raw</code>.</p>
        </div>

        <form id="upload-form" class="space-y-4">
          <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-6 py-5 flex items-start gap-4 shadow-sm">
            <div class="flex-shrink-0 text-indigo-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15.75l7.5-7.5 4.5 4.5 6-6M3 20.25h18" />
              </svg>
            </div>
            <div class="w-full space-y-3">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <label for="file-input" class="text-sm font-medium text-gray-800">Оберіть файл для завантаження</label>
                <input id="file-input" name="file" type="file" accept=".csv,.xlsx" class="block w-full sm:w-auto text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white file:text-sm hover:file:bg-indigo-700 focus:outline-none" required />
              </div>
              <div class="flex flex-wrap gap-3">
                <button type="submit" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-xl shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Завантажити таблицю</button>
                <p class="text-xs text-gray-500">Формати: .csv, .xlsx · Максимальний розмір 5MB</p>
              </div>
            </div>
          </div>

          <div id="alert-success" class="hidden rounded-xl border border-green-200 bg-green-50 text-green-800 px-4 py-3 text-sm shadow-sm">Файл успішно завантажено та оброблено.</div>
          <div id="alert-error" class="hidden rounded-xl border border-red-200 bg-red-50 text-red-800 px-4 py-3 text-sm shadow-sm"></div>
        </form>

        <div class="space-y-3">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Завантажені товари</h3>
              <p class="text-sm text-gray-600">Показані перші 100 записів із файлу.</p>
            </div>
            <span id="product-count" class="text-sm text-gray-500">Немає даних</span>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 rounded-xl overflow-hidden shadow-sm">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Назва товару</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Код</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">Кількість характеристик</th>
                </tr>
              </thead>
              <tbody id="product-table" class="divide-y divide-slate-200 bg-white text-sm"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    const setActiveTab = (target) => {
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === target;
        btn.classList.toggle('bg-slate-100', isActive);
        btn.classList.toggle('text-indigo-600', isActive);
        btn.classList.toggle('border', isActive);
        btn.classList.toggle('border-slate-200', isActive);
      });

      tabPanels.forEach((panel) => {
        panel.classList.toggle('hidden', panel.id !== `tab-${target}`);
      });
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });

    setActiveTab('dashboard');

    const uploadForm = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const tableBody = document.getElementById('product-table');
    const productCount = document.getElementById('product-count');
    const alertSuccess = document.getElementById('alert-success');
    const alertError = document.getElementById('alert-error');

    const resetAlerts = () => {
      alertSuccess.classList.add('hidden');
      alertError.classList.add('hidden');
      alertError.textContent = '';
    };

    const parseAttributes = (raw = '') => {
      return raw
        .split(';')
        .map((pair) => pair.trim())
        .filter(Boolean);
    };

    const renderProducts = (products) => {
      tableBody.innerHTML = '';

      if (!products.length) {
        tableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">Дані відсутні</td></tr>';
        productCount.textContent = 'Немає даних';
        return;
      }

      products.slice(0, 100).forEach((product) => {
        const row = document.createElement('tr');
        const nameShort = (product.name || '').length > 60 ? `${product.name.slice(0, 57)}…` : product.name || '';
        const attrsCount = Array.isArray(product.attributes_parsed) ? product.attributes_parsed.length : 0;

        row.innerHTML = `
          <td class="px-4 py-3 text-gray-900">${nameShort}</td>
          <td class="px-4 py-3 text-gray-700">${product.code || ''}</td>
          <td class="px-4 py-3 text-gray-700">${attrsCount}</td>
        `;

        tableBody.appendChild(row);
      });

      productCount.textContent = `Завантажено ${products.length} товар(и)`;
    };

    const parseCsv = async (file) => {
      const text = await file.text();
      const [headerLine, ...rows] = text.split(/\r?\n/).filter(Boolean);
      const headers = headerLine.split(',').map((h) => h.trim());
      const nameIdx = headers.findIndex((h) => h.toLowerCase() === 'name');
      const codeIdx = headers.findIndex((h) => h.toLowerCase() === 'code');
      const attrIdx = headers.findIndex((h) => h.toLowerCase() === 'attributes_raw');

      if (nameIdx === -1 || codeIdx === -1 || attrIdx === -1) {
        throw new Error('Відсутні необхідні колонки name, code, attributes_raw.');
      }

      return rows.map((line) => {
        const cols = line.split(',');
        const attributes_parsed = parseAttributes(cols[attrIdx] || '');
        return {
          name: cols[nameIdx] || '',
          code: cols[codeIdx] || '',
          attributes_parsed,
        };
      });
    };

    const buildMockProducts = (filename) => {
      return [
        {
          name: `Зразок з ${filename}: Смартфон Pro 128GB Midnight Black з довгою назвою для обрізки`,
          code: 'SKU-001',
          attributes_parsed: ['color:black', 'storage:128GB', 'display:6.5"'],
        },
        {
          name: 'Бездротові навушники Noise Canceling',
          code: 'SKU-002',
          attributes_parsed: ['color:white', 'bluetooth:5.2', 'battery:30h', 'weight:180g'],
        },
      ];
    };

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      resetAlerts();

      const file = fileInput.files[0];
      if (!file) {
        alertError.textContent = 'Оберіть файл для завантаження.';
        alertError.classList.remove('hidden');
        return;
      }

      const ext = file.name.split('.').pop().toLowerCase();

      try {
        let products = [];

        if (ext === 'csv') {
          products = await parseCsv(file);
        } else if (ext === 'xlsx') {
          products = buildMockProducts(file.name);
        } else {
          throw new Error('Непідтримуваний формат файлу. Використовуйте CSV або XLSX.');
        }

        renderProducts(products);
        alertSuccess.classList.remove('hidden');
        setActiveTab('upload');
      } catch (error) {
        alertError.textContent = error.message || 'Сталася помилка під час завантаження.';
        alertError.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
